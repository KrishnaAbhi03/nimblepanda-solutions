name: Inject color-fix.js into HTML files

on:
  workflow_dispatch:  # Allows manual trigger
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'contact.html'

permissions:
  contents: write

jobs:
  inject-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject color-fix.js script tag
        id: inject
        run: |
          #!/bin/bash
          set -e
          
          echo "üîç Checking HTML files for color-fix.js injection..."
          
          # Function to inject script tag after </title>
          inject_script() {
            local file=$1
            local script_tag='    <script src="color-fix.js"></script>'
            
            # Check if script tag already exists
            if grep -q "color-fix.js" "$file"; then
              echo "‚úÖ $file already has color-fix.js - skipping"
              return 1
            fi
            
            echo "üìù Injecting script tag into $file..."
            
            # Create temp file with injection using sed
            sed "/<\/title>/a\\
$script_tag" "$file" > "$file.tmp"
            
            # Verify the change was made
            if ! grep -q "color-fix.js" "$file.tmp"; then
              echo "‚ùå Failed to inject into $file"
              rm -f "$file.tmp"
              return 1
            fi
            
            # Replace original file
            mv "$file.tmp" "$file"
            echo "‚úÖ Successfully injected into $file"
            return 0
          }
          
          # Process HTML files
          changed=false
          
          for file in index.html contact.html about.html associated.html; do
            if [ -f "$file" ]; then
              if inject_script "$file"; then
                changed=true
              fi
            else
              echo "‚ö†Ô∏è  File $file not found, skipping..."
            fi
          done
          
          # Set output for next step
          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.inject.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.html
          git commit -m "üé® Auto-inject color-fix.js script into HTML files

This commit automatically adds the color-fix.js script tag to all HTML files
to ensure consistent color theming across the website.

Files modified:
$(git diff --name-only HEAD^)"
          git push

      - name: Summary
        run: |
          echo "## üé® Color Fix Injection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.inject.outputs.changed }}" = "true" ]; then
            echo "‚úÖ Successfully injected color-fix.js into HTML files!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Files Modified:" >> $GITHUB_STEP_SUMMARY
            echo "- index.html" >> $GITHUB_STEP_SUMMARY
            echo "- contact.html" >> $GITHUB_STEP_SUMMARY
            echo "- about.html" >> $GITHUB_STEP_SUMMARY
            echo "- associated.html" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üöÄ Changes have been committed and pushed to the main branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è No changes needed - color-fix.js already present in all HTML files" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the live site: https://krishnaabhi03.github.io/nimblepanda-solutions/" >> $GITHUB_STEP_SUMMARY
